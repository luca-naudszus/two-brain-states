---
title: "Coverage two-brain state"
author: "Luca A. Naudszus"
date: "2025-03-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load packages
library(emmeans)
library(lme4)
library(MASS)
library(tidyverse)
library(viridis)

theme_set(theme_light()+
            theme(
              plot.title = element_text(size=rel(1),face="bold"),
              panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              panel.background = element_blank(),
              axis.title = element_text(size=rel(1),face="bold"),
              axis.text = element_text(size=rel(1),colour = 'black'),
              strip.text = element_text(size=rel(1),colour = 'black', 
                                        face = "bold"),
              legend.text = element_text(size=rel(1)),
              legend.title = element_text(size=rel(1),face="bold")))


```

## Load data

```{r load_data}
# load data
fn = dir('results',
         pattern = paste("coverage_table_four_blocks",
                         sep = "_"))[1]
coverage_table = read.csv(file.path('results', fn))
coverage_table$activity[coverage_table$activity == "Together_1" | coverage_table$activity == "Together_2"] = "Together"
coverage_table <- coverage_table %>%
  mutate(cluster = factor(cluster),
         group = factor(group),
         activity = factor(activity),
         session = as.numeric(session),
         dyadType = factor(case_when(
           dyadType == "True" ~ "Real",
           TRUE ~ "Pseudo"))) %>%
#  mutate(session = factor(session, levels = c(1, 2, 3, 4, 5, 6))) %>%
  mutate(id = factor(id))
str(coverage_table)
```

## Data exploration by clusters

```{r plot1, echo=FALSE}
ggplot(coverage_table, aes(x=session, y=coverage,
                           color=interaction(dyadType, group))) +
    # geom_boxplot(position=position_dodge(.9)) +
  geom_jitter(alpha = .7, shape = 21, size =.5, width = 0.1) +
  geom_smooth(method = "lm") +
  scale_color_manual(values=c("pink", "red", "grey", "darkgrey", "lightblue", "blue")) +
  facet_grid(activity+dyadType~cluster)

ggsave("two-brain-state_byclusters.png", width = 7, height = 4, dpi = 400)
```

## Data exploration by sessions

```{r plot2, echo=FALSE}
ggplot(coverage_table, aes(x=cluster, y=coverage, color=activity)) +
  geom_boxplot(position=position_dodge(.9)) +
  scale_color_manual(values=c("red", "blue")) + 
  facet_grid(group~session)
ggsave("two-brain-state_bysessions.png", width = 7, height = 4, dpi = 400)
```

## Fit model

```{r fit, message=FALSE}
# define model
model1a <- 'coverage ~ cluster*activity*group'

# fit model
fit1a = glm.nb(model1a, data = coverage_table)
anova(fit1a)
summary(fit1a)
```

## Contrast analysis

```{r contrasts, message=FALSE}

# Get all estimated means in data frame
emm1a <- emmeans(fit1a, specs=~cluster*activity*group, data=coverage_table, type="response") 
df.emm1a <- emm1a %>% as_tibble()

# Custom contrasts
patterns <- list()
foo <- c("alone_old", "together_old", "alone_young", "together_young")
n_clusters <- length(levels(coverage_table$cluster))
for (j in 1:length(foo)) {
  for (i in 1:n_clusters) {
    pattern <- rep(0, length(foo)*n_clusters)
    pattern[i + (j-1)*n_clusters] <- 1
    patterns[[paste0("c", i, "_", foo[j])]] <- pattern
  }
}

# plot heat map
breaks = c((min(df.emm1a$response) + 0.001), (max(df.emm1a$response)-0.001))
ggplot(df.emm1a, aes(x=cluster, y=activity, fill=response)) + 
  geom_tile() + 
  scale_fill_viridis(option="magma", breaks=breaks, labels=c("lower", "higher")) + 
  facet_grid(~group)
```